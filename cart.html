<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping Cart - Checkout</title>
  <link rel="stylesheet" href="cart.css" />
</head>

<body>
  <div class="checkout-container">
    <!-- Header -->
    <div class="checkout-header">
      <div class="header-content">
        <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back to Shopping</button>
        <h1>Checkout</h1>
      </div>
    </div>

    <div class="checkout-wrapper">
      <!-- Left Section: Review Items & Delivery -->
      <div class="checkout-left">
        <!-- Review Items -->
        <div class="section-card">
          <h2 class="section-title">Review Items & Shipping</h2>
          <div id="cartItemsContainer" class="cart-items-list">
            <p class="empty-message">Your cart is empty!</p>
          </div>

          <!-- Returning Customer -->
          <div class="returning-customer">
            <label class="checkbox-label">
              <input type="checkbox" id="returningCustomer" />
              <span>I'm a returning customer</span>
            </label>
          </div>
        </div>

        <!-- Delivery Information Form -->
        <div class="section-card">
          <h2 class="section-title">Delivery Information</h2>

          <!-- Delivery Form -->
          <form class="delivery-form" id="deliveryFormSection">
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" placeholder="John" required />
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" placeholder="Doe" required />
              </div>
            </div>

            <div class="form-group">
              <label for="address">Address *</label>
              <input type="text" id="address" placeholder="123 Main Street" required />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" placeholder="New York" required />
              </div>
              <div class="form-group">
                <label for="zipcode">Zip Code *</label>
                <input type="text" id="zipcode" placeholder="10001" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="phone">Mobile *</label>
                <input type="tel" id="phone" placeholder="+1 (555) 123-4567" required />
              </div>
              <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" placeholder="john@example.com" required />
              </div>
            </div>

            <!-- Error Message -->
            <div id="formError" class="form-error" style="display: none;"></div>

            <!-- Save Address Button -->
            <button type="button" class="save-address-btn" onclick="saveDeliveryAddress()">Save Address</button>
          </form>

          <!-- Saved Address Summary Card -->
          <div id="savedAddressCard" class="saved-address-card" style="display: none;">
            <div class="saved-address-header">
              <h3>Saved Address</h3>
              <button type="button" class="edit-btn" onclick="editDeliveryAddress()">Edit</button>
            </div>
            <div class="saved-address-content">
              <div class="address-item">
                <p class="address-label">Name</p>
                <p class="address-value" id="savedName"></p>
              </div>
              <div class="address-item">
                <p class="address-label">Address</p>
                <p class="address-value" id="savedAddress"></p>
              </div>
              <div class="address-item">
                <p class="address-label">City & Zip</p>
                <p class="address-value" id="savedCityZip"></p>
              </div>
              <div class="address-item">
                <p class="address-label">Mobile</p>
                <p class="address-value" id="savedMobile"></p>
              </div>
              <div class="address-item">
                <p class="address-label">Email</p>
                <p class="address-value" id="savedEmail"></p>
              </div>
            </div>
          </div>

          <!-- No Saved Address Message -->
          <div id="noSavedAddress" class="no-saved-address" style="display: none;">
            <p>No saved address found. Please fill in the form to save your address.</p>
          </div>
        </div>
      </div>

      <!-- Right Section: Order Summary & Payment -->
      <div class="checkout-right">
        <!-- Order Summary -->
        <div class="order-summary-card">
          <h2 class="section-title">Order Summary</h2>

          <!-- Coupon Section -->
          <div class="coupon-section">
            <div class="coupon-input-group">
              <input type="text" id="couponCode" placeholder="Enter coupon code" class="coupon-input" />
              <button class="coupon-btn" onclick="applyCoupon()">Apply</button>
            </div>
            <div id="couponMessage" class="coupon-message"></div>
          </div>

          <!-- Order Items Summary -->
          <div class="order-items" id="orderItemsSummary">
            <!-- Items will be populated by JavaScript -->
          </div>

          <!-- Price Breakdown -->
          <div class="price-breakdown">
            <div class="price-row">
              <span>Subtotal</span>
              <span>$<span id="subtotalPrice">0</span></span>
            </div>
            <div class="price-row">
              <span>Discount <span id="discountLabel"></span></span>
              <span class="discount-price">-$<span id="discountPrice">0</span></span>
            </div>
            <div class="price-row">
              <span>Shipping</span>
              <span id="shippingPrice">Free</span>
            </div>
            <div class="price-row total-row">
              <span>Total</span>
              <span>$<span id="totalPrice">0</span></span>
            </div>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="payment-card">
          <h2 class="section-title">Payment Method</h2>

          <!-- Payment Options -->
          <div class="payment-options">
            <!-- Cash on Delivery -->
            <label class="payment-option">
              <input type="radio" name="paymentMethod" value="cod" />
              <div class="payment-option-content">
                <div class="payment-option-header">
                  <span class="radio-custom"></span>
                  <span class="payment-name">Cash on Delivery</span>
                </div>
                <p class="payment-desc">Pay when you receive your order</p>
              </div>
            </label>

            <!-- Credit / Debit Card -->
            <label class="payment-option">
              <input type="radio" name="paymentMethod" value="card" />
              <div class="payment-option-content">
                <div class="payment-option-header">
                  <span class="radio-custom"></span>
                  <span class="payment-name">Credit / Debit Card</span>
                  <div class="card-icons">
                    <img src="./img/visa.png" alt="Visa" class="card-icon" />
                    <img src="./img/master.png" alt="Mastercard" class="card-icon" />
                  </div>
                </div>
                <p class="payment-desc">Secure payment with your card</p>
              </div>
            </label>

            <!-- PayPal -->
            <label class="payment-option">
              <input type="radio" name="paymentMethod" value="paypal" />
              <div class="payment-option-content">
                <div class="payment-option-header">
                  <span class="radio-custom"></span>
                  <span class="payment-name">PayPal</span>
                </div>
                <p class="payment-desc">Fast and secure PayPal payment</p>
              </div>
            </label>
          </div>

          <!-- Card Details (Hidden by default) -->
          <div id="cardDetails" class="card-details" style="display: none;">
            <div class="form-group">
              <label for="cardName">Name on Card *</label>
              <input type="text" id="cardName" placeholder="John Doe" />
            </div>

            <div class="form-group">
              <label for="cardNumber">Card Number *</label>
              <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="cardExpiry">Expiry Date *</label>
                <input type="text" id="cardExpiry" placeholder="MM/YY" />
              </div>
              <div class="form-group">
                <label for="cardCVC">CVC *</label>
                <input type="text" id="cardCVC" placeholder="123" />
              </div>
            </div>
          </div>
        </div>

        <!-- Place Order Button -->
        <div id="orderError" class="order-error" style="display: none;"></div>
        <button class="place-order-btn" onclick="placeOrder()">Place Order</button>
      </div>
    </div>
  </div>

  <script>
    // Load cart from localStorage
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let discountPercent = 0;

    // Initialize quantities for cart items
    function initializeQuantities() {
      cart.forEach((item) => {
        if (!item.quantity) {
          item.quantity = 1;
        }
      });
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    initializeQuantities();

    function calculateTotals() {
      let subtotal = 0;
      let totalItems = 0;

      cart.forEach((item) => {
        const quantity = item.quantity || 1;
        subtotal += item.price * quantity;
        totalItems += quantity;
      });

      const discount = Math.round((subtotal * discountPercent) / 100);
      const shipping = subtotal > 300 ? 0 : 0; // Free shipping logic
      const total = subtotal - discount + shipping;

      return {
        subtotal,
        discount,
        shipping,
        total,
        totalItems,
      };
    }

    function displayCart() {
      const container = document.getElementById('cartItemsContainer');
      const orderSummary = document.getElementById('orderItemsSummary');

      if (cart.length === 0) {
        container.innerHTML = '<p class="empty-message">Your cart is empty!</p>';
        orderSummary.innerHTML = '';
        updatePrices();
        return;
      }

      let cartHTML = '';
      let summaryHTML = '';

      cart.forEach((item, index) => {
        const quantity = item.quantity || 1;
        const subtotal = item.price * quantity;

        // Cart items list (left section)
        cartHTML += `
          <div class="cart-item">
            <div class="item-image">
              <img src="${item.img}" alt="${item.title}">
            </div>
            <div class="item-details">
              <h4>${item.title}</h4>
              <p class="item-spec">Size: <span>${item.size || 'N/A'}</span></p>
              <p class="item-spec">Quantity: <span>${quantity}</span></p>
              <p class="item-price">$${item.price}</p>
            </div>
            <div class="item-qty">
              <button class="qty-btn" onclick="changeQuantity(${index}, -1)">‚àí</button>
              <span>${quantity}</span>
              <button class="qty-btn" onclick="changeQuantity(${index}, 1)">+</button>
            </div>
          </div>
        `;

        // Order summary (right section)
        summaryHTML += `
          <div class="summary-item">
            <div class="summary-item-info">
              <p class="summary-item-name">${item.title} (Size ${item.size || 'N/A'})</p>
              <p class="summary-item-qty">Qty: ${quantity}</p>
            </div>
            <p class="summary-item-price">$${subtotal}</p>
          </div>
        `;
      });

      container.innerHTML = cartHTML;
      orderSummary.innerHTML = summaryHTML;
      updatePrices();
    }

    function updatePrices() {
      const { subtotal, discount, shipping, total } = calculateTotals();

      document.getElementById('subtotalPrice').textContent = subtotal;
      document.getElementById('discountPrice').textContent = discount;
      document.getElementById('totalPrice').textContent = total;
      document.getElementById('shippingPrice').textContent =
        shipping === 0 ? 'Free' : `$${shipping}`;
    }

    function changeQuantity(index, change) {
      if (index >= 0 && index < cart.length) {
        const currentQty = cart[index].quantity || 1;
        const newQty = currentQty + change;

        if (newQty >= 1) {
          cart[index].quantity = newQty;
          localStorage.setItem('cart', JSON.stringify(cart));
          displayCart();
          clearOrderError(); // Clear error when cart changes
        }
      }
    }

    function applyCoupon() {
      const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
      const message = document.getElementById('couponMessage');

      // Sample coupon codes
      const coupons = {
        'SAVE10': 10,
        'SAVE20': 20,
        'WELCOME': 15,
      };

      if (coupons[couponCode]) {
        discountPercent = coupons[couponCode];
        message.textContent = `‚úì Coupon applied! ${discountPercent}% off`;
        message.style.color = '#22c55e';
        document.getElementById('discountLabel').textContent = `(${discountPercent}%)`;
        updatePrices();
      } else {
        discountPercent = 0;
        message.textContent = '‚úó Invalid coupon code';
        message.style.color = '#ef4444';
        document.getElementById('discountLabel').textContent = '';
        updatePrices();
      }
    }

    function toggleCardDetails() {
      const cardDetails = document.getElementById('cardDetails');
      const cardRadio = document.querySelector('input[value="card"]:checked');
      cardDetails.style.display = cardRadio ? 'block' : 'none';
    }

    function placeOrder() {
      const orderErrorEl = document.getElementById('orderError');

      // Clear previous error
      orderErrorEl.style.display = 'none';
      orderErrorEl.textContent = '';

      // Validation 1: Check if cart is empty
      if (cart.length === 0) {
        orderErrorEl.textContent = 'üõí Your cart is empty. Please add items before placing the order.';
        orderErrorEl.style.display = 'block';
        orderErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      // Validation 2: Check if delivery address is selected
      const savedAddress = getSavedAddress();
      const returningCustomer = document.getElementById('returningCustomer').checked;
      const formVisible = document.getElementById('deliveryFormSection').style.display !== 'none';

      // Address is valid if:
      // - Returning customer is checked AND saved address exists (card is showing)
      // - OR form is filled and saved
      if (returningCustomer && !savedAddress) {
        orderErrorEl.textContent = 'üìç Please select a delivery address. Save your address first.';
        orderErrorEl.style.display = 'block';
        orderErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      if (!returningCustomer || formVisible) {
        // Form is visible, validate it
        const validation = validateDeliveryForm();
        if (!validation.valid) {
          orderErrorEl.textContent = 'üìç ' + validation.message + ' Please save your delivery address.';
          orderErrorEl.style.display = 'block';
          orderErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        // Check if address was actually saved
        if (!savedAddress) {
          orderErrorEl.textContent = 'üìç Please click "Save Address" button before placing the order.';
          orderErrorEl.style.display = 'block';
          orderErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
      }

      // Validation 3: Check if payment method is selected
      const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
      if (!selectedPayment) {
        orderErrorEl.textContent = 'üí≥ Please select a payment method.';
        orderErrorEl.style.display = 'block';
        orderErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      // If card payment, validate card details
      if (selectedPaymentMethod === 'card') {
        const cardName = document.getElementById('cardName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const cardExpiry = document.getElementById('cardExpiry').value.trim();
        const cardCVC = document.getElementById('cardCVC').value.trim();

        if (!cardName || !cardNumber || !cardExpiry || !cardCVC) {
          orderErrorEl.textContent = 'üí≥ Please fill in all card details.';
          orderErrorEl.style.display = 'block';
          orderErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
      }

      // All validations passed - place the order
      alert('Order placed successfully! üéâ');
      localStorage.removeItem('cart');
      cart = [];
      displayCart();
    }

    // Event listeners
    let selectedPaymentMethod = null;
    const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');

    function handlePaymentMethodChange(radio) {
      // Store the selected payment method
      selectedPaymentMethod = radio.value;

      // Update UI state
      toggleCardDetails();

      // Clear order error when payment method is selected
      document.getElementById('orderError').style.display = 'none';

      console.log('Payment method selected:', selectedPaymentMethod);
    }

    // Initialize payment method listeners
    paymentMethodRadios.forEach((radio) => {
      radio.addEventListener('change', (e) => {
        handlePaymentMethodChange(e.target);
      });
    });

    // Clear error when items are added/changed in cart
    function clearOrderError() {
      document.getElementById('orderError').style.display = 'none';
    }

    // ============================================
    // DELIVERY INFORMATION LOGIC
    // ============================================

    // Get saved address from localStorage
    function getSavedAddress() {
      const saved = localStorage.getItem('savedDeliveryAddress');
      return saved ? JSON.parse(saved) : null;
    }

    // Validate delivery form fields
    function validateDeliveryForm() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const address = document.getElementById('address').value.trim();
      const city = document.getElementById('city').value.trim();
      const zipcode = document.getElementById('zipcode').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!firstName || !lastName || !address || !city || !zipcode || !phone || !email) {
        return { valid: false, message: 'Please fill in all required fields.' };
      }

      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return { valid: false, message: 'Please enter a valid email address.' };
      }

      return { valid: true };
    }

    // Save delivery address to localStorage
    function saveDeliveryAddress() {
      const validation = validateDeliveryForm();

      if (!validation.valid) {
        const errorEl = document.getElementById('formError');
        errorEl.textContent = validation.message;
        errorEl.style.display = 'block';
        return;
      }

      // Hide error if validation passed
      document.getElementById('formError').style.display = 'none';

      // Clear order error when address is saved
      clearOrderError();

      const address = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        address: document.getElementById('address').value.trim(),
        city: document.getElementById('city').value.trim(),
        zipcode: document.getElementById('zipcode').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
      };

      localStorage.setItem('savedDeliveryAddress', JSON.stringify(address));

      // If returning customer is checked, show saved address card
      if (document.getElementById('returningCustomer').checked) {
        displaySavedAddressCard();
      }
    }

    // Display saved address in the card
    function displaySavedAddressCard() {
      const savedAddr = getSavedAddress();

      if (!savedAddr) {
        return;
      }

      document.getElementById('savedName').textContent = `${savedAddr.firstName} ${savedAddr.lastName}`;
      document.getElementById('savedAddress').textContent = savedAddr.address;
      document.getElementById('savedCityZip').textContent = `${savedAddr.city} ‚Äì ${savedAddr.zipcode}`;
      document.getElementById('savedMobile').textContent = savedAddr.phone;
      document.getElementById('savedEmail').textContent = savedAddr.email;

      document.getElementById('deliveryFormSection').style.display = 'none';
      document.getElementById('savedAddressCard').style.display = 'block';
      document.getElementById('noSavedAddress').style.display = 'none';
    }

    // Edit delivery address
    function editDeliveryAddress() {
      const savedAddr = getSavedAddress();

      // Show form, hide card
      document.getElementById('deliveryFormSection').style.display = 'block';
      document.getElementById('savedAddressCard').style.display = 'none';
      document.getElementById('noSavedAddress').style.display = 'none';
      document.getElementById('formError').style.display = 'none';

      // Prefill form with saved data
      if (savedAddr) {
        document.getElementById('firstName').value = savedAddr.firstName;
        document.getElementById('lastName').value = savedAddr.lastName;
        document.getElementById('address').value = savedAddr.address;
        document.getElementById('city').value = savedAddr.city;
        document.getElementById('zipcode').value = savedAddr.zipcode;
        document.getElementById('phone').value = savedAddr.phone;
        document.getElementById('email').value = savedAddr.email;
      }
    }

    // Toggle returning customer checkbox behavior
    function toggleReturningCustomer() {
      const isChecked = document.getElementById('returningCustomer').checked;
      const formSection = document.getElementById('deliveryFormSection');
      const savedCard = document.getElementById('savedAddressCard');
      const noSavedMsg = document.getElementById('noSavedAddress');

      if (isChecked) {
        // Check if saved address exists
        const savedAddr = getSavedAddress();

        if (savedAddr) {
          // Show saved address card
          displaySavedAddressCard();
        } else {
          // No saved address - show message and keep form visible
          formSection.style.display = 'block';
          savedCard.style.display = 'none';
          noSavedMsg.style.display = 'block';
        }
      } else {
        // Show form, hide everything else
        formSection.style.display = 'block';
        savedCard.style.display = 'none';
        noSavedMsg.style.display = 'none';
      }
    }

    // Initialize returning customer checkbox listener
    document.getElementById('returningCustomer').addEventListener('change', toggleReturningCustomer);

    // Initialize on page load
    function initializePage() {
      // Form starts empty - no auto-fill
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('address').value = '';
      document.getElementById('city').value = '';
      document.getElementById('zipcode').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('email').value = '';

      // Form is visible, cards hidden
      document.getElementById('deliveryFormSection').style.display = 'block';
      document.getElementById('savedAddressCard').style.display = 'none';
      document.getElementById('noSavedAddress').style.display = 'none';

      // Reset payment method selection - NO payment method selected by default
      paymentMethodRadios.forEach((radio) => {
        radio.checked = false;
      });
      selectedPaymentMethod = null;
      document.getElementById('cardDetails').style.display = 'none';

      console.log('Payment methods initialized - no default selection');

      displayCart();
    }

    // Display cart on page load
    initializePage();
  </script>
</body>

</html>